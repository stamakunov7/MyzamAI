name: ğŸ§ª MyzamAI Tests

on:
  push:
    branches: [ main, develop, feature/*, hotfix/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
        test-type: ["unit", "integration"]
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for better analysis
    
    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ğŸ“¦ Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: â¬†ï¸ Upgrade pip
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
    
    - name: ğŸ“š Install core dependencies
      run: |
        pip install -r requirements.txt
        echo "âœ… Core dependencies installed"
    
    - name: ğŸ§ª Install test dependencies
      run: |
        pip install -r requirements-test.txt
        echo "âœ… Test dependencies installed"
    
    - name: ğŸ” Verify installation
      run: |
        python --version
        pytest --version
        echo "âœ… Installation verified"
    
    - name: ğŸ”§ Set up environment variables
      run: |
        echo "TELEGRAM_BOT_TOKEN=dummy_token_for_testing" >> $GITHUB_ENV
        echo "HUGGINGFACE_API_TOKEN=dummy_token_for_testing" >> $GITHUB_ENV
        echo "âœ… Environment variables set for testing"
    
    - name: ğŸ—ï¸ Build FAISS index (if needed)
      run: |
        if [ ! -f "storage/faiss_index/faiss_index.bin" ]; then
          echo "âš™ï¸ Building FAISS index..."
          python scripts/build_faiss_index.py
          echo "âœ… FAISS index built"
        else
          echo "âœ… FAISS index already exists"
        fi
    
    - name: ğŸ§ª Run ${{ matrix.test-type }} tests
      run: |
        echo "ğŸš€ Running ${{ matrix.test-type }} tests..."
        python -m pytest -m ${{ matrix.test-type }} \
          --cov=src \
          --cov-report=term-missing \
          --cov-report=xml \
          --junitxml=test-results-${{ matrix.test-type }}.xml \
          --maxfail=5 \
          --disable-warnings \
          --asyncio-mode=auto \
          -v
        echo "âœ… ${{ matrix.test-type }} tests completed"
    
    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.test-type }}-py${{ matrix.python-version }}
        path: |
          test-results-*.xml
          coverage.xml
          .coverage
    
    # Coverage upload is handled in the dedicated coverage job
    
    - name: ğŸ¯ Display summary
      if: always()
      run: |
        echo "ğŸ“Š Test Summary for ${{ matrix.test-type }} tests (Python ${{ matrix.python-version }})"
        echo "âœ… MyzamAI ${{ matrix.test-type }} tests completed!"
        echo "ğŸ Python version: ${{ matrix.python-version }}"
        echo "ğŸ§ª Test type: ${{ matrix.test-type }}"
        echo "ğŸƒ Runner: ${{ runner.os }}"

  coverage:
    name: ğŸ“Š Coverage Report
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request' && needs.test.result == 'success'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: ğŸ”§ Set up environment variables
      run: |
        echo "TELEGRAM_BOT_TOKEN=dummy_token_for_testing" >> $GITHUB_ENV
        echo "HUGGINGFACE_API_TOKEN=dummy_token_for_testing" >> $GITHUB_ENV
        echo "âœ… Environment variables set for testing"
    
    - name: ğŸ“š Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: ğŸ§ª Run all tests with coverage
      run: |
        pytest --cov=src \
          --cov-report=html \
          --cov-report=xml \
          --cov-report=term-missing \
          --junitxml=test-results.xml \
          --maxfail=1 \
          --disable-warnings \
          --asyncio-mode=auto \
          -v
    
    - name: ğŸ“Š Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
    
    - name: ğŸ“ˆ Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true
        verbose: true

  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: ğŸ”§ Set up environment variables
      run: |
        echo "TELEGRAM_BOT_TOKEN=dummy_token_for_testing" >> $GITHUB_ENV
        echo "HUGGINGFACE_API_TOKEN=dummy_token_for_testing" >> $GITHUB_ENV
        echo "âœ… Environment variables set for testing"
    
    - name: ğŸ“š Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: âš¡ Run performance tests
      run: |
        echo "ğŸš€ Running performance tests..."
        pytest -m performance \
          --benchmark-only \
          --benchmark-save=performance \
          --benchmark-save-data \
          --maxfail=1 \
          --disable-warnings \
          --asyncio-mode=auto \
          -v
        echo "âœ… Performance tests completed"
    
    - name: ğŸ“Š Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: .benchmarks/

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'
    
    - name: ğŸ”§ Set up environment variables
      run: |
        echo "TELEGRAM_BOT_TOKEN=dummy_token_for_testing" >> $GITHUB_ENV
        echo "HUGGINGFACE_API_TOKEN=dummy_token_for_testing" >> $GITHUB_ENV
        echo "âœ… Environment variables set for testing"
    
    - name: ğŸ“š Install dependencies
      run: |
        pip install -r requirements.txt
        pip install safety bandit
    
    - name: ğŸ”’ Run security scan
      run: |
        echo "ğŸ” Running security scan..."
        safety check --json --output safety-report.json || true
        bandit -r . -f json -o bandit-report.json || true
        echo "âœ… Security scan completed"
    
    - name: ğŸ“Š Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json

  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [test, coverage]
    if: always()
    
    steps:
    - name: ğŸ“Š Test Results Summary
      run: |
        echo "ğŸ¯ MyzamAI CI/CD Results Summary"
        echo "=================================="
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— Repository: ${{ github.repository }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo ""
        echo "ğŸ§ª Test Status:"
        echo "  - Unit Tests: ${{ needs.test.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"
        echo "  - Integration Tests: ${{ needs.test.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"
        echo "  - Coverage Report: ${{ needs.coverage.result == 'success' && 'âœ… PASSED' || 'â­ï¸ SKIPPED' }}"
        echo ""
        echo "ğŸ‰ MyzamAI tests completed successfully!"
        echo "ğŸ“Š Check the Actions tab for detailed results"
